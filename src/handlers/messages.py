"""
–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —Å RAG
"""
import asyncio
from aiogram import types
from aiogram.types import InputFile
from utils.session_db import get_active_session, get_conn
from handlers.sessions import save_user_turn
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º RAG –∞–≥–µ–Ω—Ç–∞
from llm.agents.rag_consultant_agent import RAGConsultantAgent

# –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä RAG –∞–≥–µ–Ω—Ç–∞
rag_agent = RAGConsultantAgent()

async def handle_text_message(message: types.Message, bot):
    """
    –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º RAG
    """
    text = (message.text or "").strip()
    if not text:
        await message.reply("–ü—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Äî –æ—Ç–ø—Ä–∞–≤—å, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–ø—Ä–æ—Å —Ç–µ–∫—Å—Ç–æ–º.")
        return

    # –ü–æ–∫–∞–∂–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —á—Ç–æ –±–æ—Ç '–ø–µ—á–∞—Ç–∞–µ—Ç'
    try:
        await bot.send_chat_action(chat_id=message.chat.id, action=types.ChatActions.TYPING)
    except Exception:
        pass

    info = await message.reply("üîç –ò—â—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –æ–±—â–µ–∂–∏—Ç–∏–π –ú–ò–§–ò...")

    try:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º RAG –∞–≥–µ–Ω—Ç–∞ –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ –≤—ã–∑–æ–≤–∞ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏
        result = await rag_agent.ask_question(
            question=text, 
            user_id=str(message.from_user.id),
            limit=3
        )
        
        answer = result["answer"]
        sources_count = result["sources_count"]
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö
        if sources_count > 0:
            response_text = f"**–û—Ç–≤–µ—Ç:** {answer}\n\nüìö *–ù–∞–π–¥–µ–Ω–æ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π: {sources_count} –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤*"
        else:
            response_text = f"**–û—Ç–≤–µ—Ç:** {answer}\n\n‚ÑπÔ∏è *–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π*"
        
        await info.edit_text(response_text, parse_mode='Markdown')
        
    except Exception as e:
        await info.edit_text(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏: {e}")
async def handle_session_message_aiogram(message: types.Message, bot):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π *–≤ —Ä–∞–º–∫–∞—Ö –∞–∫—Ç–∏–≤–Ω–æ–π —Å–µ—Å—Å–∏–∏*.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ä–µ–∂–∏–º–æ–≤, –∑–∞–≤–∏—Å—è—â–∏—Ö –æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Å–µ—Å—Å–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –º–æ—Ä–∞–ª—å–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞).
    """
    user_id = message.from_user.id
    text = (message.text or "").strip()
    if not text:
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Å—Å–∏—è
    active_session = get_active_session(get_conn(), user_id)
    if not active_session:
        return

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
    try:
        await bot.send_chat_action(chat_id=message.chat.id, action=types.ChatActions.TYPING)
    except Exception:
        pass

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–µ—Å—Å–∏—é
    save_user_turn(user_id, "user", message.text)

    # --- –õ–û–ì–ò–ö–ê –ú–û–†–ê–õ–¨–ù–û–ô –ü–û–î–î–ï–†–ñ–ö–ò ---
    txt_lower = text.lower()
    morale_keywords = ["–≥—Ä—É—Å—Ç", "–ø–ª–æ—Ö–æ", "–¥–µ–ø—Ä–µ—Å", "—Å—Ç—Ä–∞—à–Ω", "—Ç–æ—Å–∫–∞", "–ø–æ–º–æ–≥–∏", "–∑–æ–≤—É", "–æ–¥–∏–Ω", "–Ω–µ –º–æ–≥—É", "—É—Å—Ç–∞–ª", "–¥–∞–≤–∏—Ç"]
    household_or_general_keywords = ["–æ–ø–ª–∞—Ç", "—Ü–µ–Ω–∞", "—Å—Ç–æ–∏–º", "–¥–æ–∫—É–º–µ–Ω—Ç", "–∑–∞—Å–µ–ª–µ–Ω", "–∫–ª—é—á", "—Å—Ç–∏—Ä–∞–ª", "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç", "–ø—Ä–∞—á–µ—á–Ω", "–ø—Ä–∞–≤–∏–ª", "–≥–¥–µ", "—á—Ç–æ", "–∫–∞–∫", "–ø–æ—á–µ–º—É"]

    if any(k in txt_lower for k in morale_keywords):
        reply = (
            "–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –ø–æ–¥–µ–ª–∏–ª—Å—è. –Ø –ø–æ–Ω–∏–º–∞—é, —á—Ç–æ —Ç–µ–±–µ —Å–µ–π—á–∞—Å —Ç—è–∂–µ–ª–æ. "
            "–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ ‚Äì –∏—Å–ø—ã—Ç—ã–≤–∞—Ç—å —Ç–∞–∫–∏–µ —á—É–≤—Å—Ç–≤–∞. "
            "–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, –º–æ–∂–µ—à—å —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –Ω–µ–º–Ω–æ–≥–æ –±–æ–ª—å—à–µ. –Ø —Ä—è–¥–æ–º –∏ —Å–ª—É—à–∞—é. "
            "–ò–Ω–æ–≥–¥–∞ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–≥–æ–≤–æ—Ä–∏—Ç—å –≤—Å–ª—É—Ö –ø–æ–º–æ–≥–∞–µ—Ç –Ω–µ–º–Ω–æ–≥–æ –ª–µ–≥—á–µ. "
            "–¢—ã –Ω–µ –æ–¥–∏–Ω. üíô"
        )
    elif any(k in txt_lower for k in household_or_general_keywords):
        reply = (
            "–Ø –≤–∏–∂—É, —Ç—ã –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–≤—è–∑–∞–Ω —Å –±—ã—Ç–æ–º. "
            "–ü–æ–∫–∞ —Ç—ã –≤ —Ä–µ–∂–∏–º–µ –º–æ—Ä–∞–ª—å–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏. "
            "–ï—Å–ª–∏ —Ö–æ—á–µ—à—å –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –æ–±—â–µ–º—É –±–æ—Ç—É –∏ –∑–∞–¥–∞—Ç—å –µ–≥–æ —Å–Ω–æ–≤–∞, –∏—Å–ø–æ–ª—å–∑—É–π –∫–æ–º–∞–Ω–¥—É /start –∏–ª–∏ /help. "
            "–ê –ø–æ–∫–∞, –¥–∞–≤–∞–π —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–∏–º—Å—è –Ω–∞ —Ç–≤–æ–µ–º —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏. "
            "–ö–∞–∫ —Ç—ã —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—à—å?"
        )
    else:
        reply = (
            "–ü—Ä–∏–Ω—è—Ç–æ. –Ø —Å–ª—ã—à—É —Ç–µ–±—è. "
            "–ï—Å–ª–∏ —Ö–æ—á–µ—à—å –ø–æ–¥–µ–ª–∏—Ç—å—Å—è —á–µ–º-—Ç–æ –µ—â—ë –∏–ª–∏ —É—Ç–æ—á–Ω–∏—Ç—å –º—ã—Å–ª—å ‚Äì –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–∞–π –ø–∏—Å–∞—Ç—å. "
            "–ï—Å–ª–∏ —Ö–æ—á–µ—à—å –∑–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ—Å—Å–∏—é –ø–æ–¥–¥–µ—Ä–∂–∫–∏, –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É '–ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ—Å—Å–∏—é' –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π –∫–æ–º–∞–Ω–¥—É /end_session."
        )

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –±–æ—Ç–∞ –≤ —Å–µ—Å—Å–∏—é
    save_user_turn(user_id, "bot", reply)

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
    await message.reply(reply)
