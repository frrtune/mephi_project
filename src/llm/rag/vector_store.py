"""
–ü—Ä–æ—Å—Ç–∞—è –≤–µ–∫—Ç–æ—Ä–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—Ç—É–¥–µ–Ω—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –ú–ò–§–ò
–í—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ú–ò–§–ò –ø—Ä–æ–ø–∏—Å–∞–Ω–∞ –ø—Ä—è–º–æ –≤ –∫–æ–¥–µ
"""
import sqlite3
from typing import List, Dict, Any

class SimpleVectorDB:
    """
    –°–£–ü–ï–† –ü–†–û–°–¢–ê–Ø –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –ø—Ä–æ –ú–ò–§–ò
    –í—Å—ë —É–∂–µ –ø—Ä–æ–ø–∏—Å–∞–Ω–æ –≤ –∫–æ–¥–µ, –Ω–µ –Ω—É–∂–Ω–æ –Ω–∏—á–µ–≥–æ —É—Å–ª–æ–∂–Ω—è—Ç—å
    """
    
    def __init__(self, db_path: str = "data/mifi_knowledge.db"):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Å—Ç–æ–π SQLite –±–∞–∑—ã"""
        self.db_path = db_path
        self._init_database()
        self._fill_with_mifi_data()  # –í—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø—Ä–æ –ú–ò–§–ò —É–∂–µ –∑–¥–µ—Å—å!
    
    def _init_database(self):
        """–°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –≤ SQLite"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS mifi_knowledge (
                id INTEGER PRIMARY KEY,
                text TEXT NOT NULL,
                category TEXT NOT NULL
            )
        ''')
        
        conn.commit()
        conn.close()
    
    def _fill_with_mifi_data(self):
        """
        –í–°–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø –ü–†–û –û–ë–©–ï–ñ–ò–¢–ò–Ø –ú–ò–§–ò –ó–î–ï–°–¨
        –ü—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤—å —Å—é–¥–∞ –Ω–æ–≤—ã–µ —Ñ–∞–∫—Ç—ã –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        """
        mifi_facts = [
            # –ê–î–†–ï–°–ê –û–ë–©–ï–ñ–ò–¢–ò–ô
            (1, "–û–±—â–µ–∂–∏—Ç–∏–µ ‚Ññ1 –ú–ò–§–ò: –ú–æ—Å–∫–≤–∞, —É–ª–∏—Ü–∞ –ú–æ—Å–∫–≤–æ—Ä–µ—á—å–µ, 2–∫1", "–ê–¥—Ä–µ—Å–∞"),
            (2, "–û–±—â–µ–∂–∏—Ç–∏–µ ‚Ññ2 –ú–ò–§–ò: –ú–æ—Å–∫–≤–∞, —É–ª–∏—Ü–∞ –ú–æ—Å–∫–≤–æ—Ä–µ—á—å–µ, 2–∫2", "–ê–¥—Ä–µ—Å–∞"),
            (3, "–û–±—â–µ–∂–∏—Ç–∏–µ ‚Ññ3 –ú–ò–§–ò: –ú–æ—Å–∫–≤–∞, —É–ª–∏—Ü–∞ –ú–æ—Å–∫–≤–æ—Ä–µ—á—å–µ, 19–∫3", "–ê–¥—Ä–µ—Å–∞"),
            (4, "–û–±—â–µ–∂–∏—Ç–∏–µ ‚Ññ4 –ú–ò–§–ò: –ú–æ—Å–∫–≤–∞, —É–ª–∏—Ü–∞ –ú–æ—Å–∫–≤–æ—Ä–µ—á—å–µ, 19–∫4", "–ê–¥—Ä–µ—Å–∞"),
            (5, "–û–±—â–µ–∂–∏—Ç–∏–µ ‚Ññ5 –ú–ò–§–ò: –ú–æ—Å–∫–≤–∞, —É–ª–∏—Ü–∞ –ö–æ—à–∫–∏–Ω–∞, 11", "–ê–¥—Ä–µ—Å–∞"),
            (6, "–û–±—â–µ–∂–∏—Ç–∏–µ ‚Ññ7 –ú–ò–§–ò: –ú–æ—Å–∫–≤–∞, —É–ª–∏—Ü–∞ –®–∫—É–ª–µ–≤–∞, 27", "–ê–¥—Ä–µ—Å–∞"),
            (8, "–û–±—â–µ–∂–∏—Ç–∏–µ ‚Ññ8 –ú–ò–§–ò: –ú–æ—Å–∫–≤–∞, –ü—Ä–æ–ª–µ—Ç–∞—Ä—Å–∫–∏–π –ø—Ä–æ—Å–ø–µ–∫—Ç, 8–∫2", "–ê–¥—Ä–µ—Å–∞"),
            (9, "–û–±—â–µ–∂–∏—Ç–∏–µ ‚Ññ9 –ú–ò–§–ò: –ú–æ—Å–∫–≤–∞, –ü—Ä–æ–ª–µ—Ç–∞—Ä—Å–∫–∏–π –ø—Ä–æ—Å–ø–µ–∫—Ç, 8–∫1", "–ê–¥—Ä–µ—Å–∞"),
            
            # –°–¢–û–ò–ú–û–°–¢–¨
            (10, "–°—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è –≤ –æ–±—â–µ–∂–∏—Ç–∏–∏ –ú–ò–§–ò: –æ—Ç 1200 –¥–æ 2500 —Ä—É–±–ª–µ–π –≤ –º–µ—Å—è—Ü", "–°—Ç–æ–∏–º–æ—Å—Ç—å"),
            (11, "–û–ø–ª–∞—Ç–∞ –æ–±—â–µ–∂–∏—Ç–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –¥–æ 10 —á–∏—Å–ª–∞ –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞", "–°—Ç–æ–∏–º–æ—Å—Ç—å"),
            
            # –ü–†–ê–í–ò–õ–ê –ü–†–û–ñ–ò–í–ê–ù–ò–Ø
            (12, "–ì–æ—Å—Ç–∏ –≤ –æ–±—â–µ–∂–∏—Ç–∏–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã –¥–æ 23:00", "–ü—Ä–∞–≤–∏–ª–∞"),
            (13, "–¢–∏—à–∏–Ω–∞ –≤ –æ–±—â–µ–∂–∏—Ç–∏–∏ —Å 23:00 –¥–æ 7:00", "–ü—Ä–∞–≤–∏–ª–∞"),
            (14, "–ö—É—Ä–∏—Ç—å –≤ –æ–±—â–µ–∂–∏—Ç–∏–∏ –∑–∞–ø—Ä–µ—â–µ–Ω–æ", "–ü—Ä–∞–≤–∏–ª–∞"),
            (15, "–ó–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è –º–æ–≥—É—Ç –≤—ã—Å–µ–ª–∏—Ç—å", "–ü—Ä–∞–≤–∏–ª–∞"),
            
            # –£–î–û–ë–°–¢–í–ê
            (16, "–í –∫–∞–∂–¥–æ–º –æ–±—â–µ–∂–∏—Ç–∏–∏ –µ—Å—Ç—å –∫—É—Ö–Ω—è –Ω–∞ —ç—Ç–∞–∂–µ", "–£–¥–æ–±—Å—Ç–≤–∞"),
            (17, "–í –æ–±—â–µ–∂–∏—Ç–∏—è—Ö –µ—Å—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π Wi-Fi", "–£–¥–æ–±—Å—Ç–≤–∞"),
            (18, "–†—è–¥–æ–º —Å –æ–±—â–µ–∂–∏—Ç–∏—è–º–∏ –µ—Å—Ç—å —Å—Ç–æ–ª–æ–≤–∞—è –ú–ò–§–ò", "–£–¥–æ–±—Å—Ç–≤–∞"),
            (19, "–í –æ–±—â–µ–∂–∏—Ç–∏—è—Ö –µ—Å—Ç—å –ø—Ä–∞—á–µ—á–Ω—ã–µ –∫–æ–º–Ω–∞—Ç—ã", "–£–¥–æ–±—Å—Ç–≤–∞"),
            (20, "–ï—Å—Ç—å –∫–æ–º–Ω–∞—Ç—ã –¥–ª—è —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–π –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏", "–£–¥–æ–±—Å—Ç–≤–∞"),
            
            # –î–û–ö–£–ú–ï–ù–¢–´ –î–õ–Ø –ó–ê–°–ï–õ–ï–ù–ò–Ø
            (21, "–î–ª—è –∑–∞—Å–µ–ª–µ–Ω–∏—è –Ω—É–∂–µ–Ω –ø–∞—Å–ø–æ—Ä—Ç", "–î–æ–∫—É–º–µ–Ω—Ç—ã"),
            (22, "–ù—É–∂–Ω–∞ —Å–ø—Ä–∞–≤–∫–∞ –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –∑–¥–æ—Ä–æ–≤—å—è", "–î–æ–∫—É–º–µ–Ω—Ç—ã"),
            (23, "–ù—É–∂–Ω—ã —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ 3x4", "–î–æ–∫—É–º–µ–Ω—Ç—ã"),
            (24, "–ù—É–∂–Ω–æ –∑–∞—è–≤–ª–µ–Ω–∏–µ –≤ –¥–µ–∫–∞–Ω–∞—Ç–µ", "–î–æ–∫—É–º–µ–Ω—Ç—ã"),
            
            # –ò–ù–§–û–†–ú–ê–¶–ò–Ø –î–õ–Ø –ò–ù–û–ì–û–†–û–î–ù–ò–•
            (25, "–ò–Ω–æ–≥–æ—Ä–æ–¥–Ω–∏–µ —Å—Ç—É–¥–µ–Ω—Ç—ã –∏–º–µ—é—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø—Ä–∏ –∑–∞—Å–µ–ª–µ–Ω–∏–∏", "–î–ª—è –∏–Ω–æ–≥–æ—Ä–æ–¥–Ω–∏—Ö"),
            (26, "–û–±—â–µ–∂–∏—Ç–∏—è –≤ 10 –º–∏–Ω—É—Ç–∞—Ö –æ—Ç —É—á–µ–±–Ω—ã—Ö –∫–æ—Ä–ø—É—Å–æ–≤", "–î–ª—è –∏–Ω–æ–≥–æ—Ä–æ–¥–Ω–∏—Ö"),
            (27, "–ë–ª–∏–∂–∞–π—à–µ–µ –º–µ—Ç—Ä–æ - –ö–∞—à–∏—Ä—Å–∫–∞—è", "–î–ª—è –∏–Ω–æ–≥–æ—Ä–æ–¥–Ω–∏—Ö"),
        ]
        
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–∞—à–∏
        cursor.execute('DELETE FROM mifi_knowledge')
        
        for fact_id, text, category in mifi_facts:
            cursor.execute(
                'INSERT OR REPLACE INTO mifi_knowledge (id, text, category) VALUES (?, ?, ?)',
                (fact_id, text, category)
            )
        
        conn.commit()
        conn.close()
        
        print(f"‚úÖ –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –ú–ò–§–ò –∑–∞–ø–æ–ª–Ω–µ–Ω–∞: {len(mifi_facts)} —Ñ–∞–∫—Ç–æ–≤")
    
    def search(self, query: str, limit: int = 5) -> List[Dict[str, Any]]:
        """
        –ü–†–û–°–¢–û–ô –ø–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
        """
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        # –†–∞–∑–±–∏–≤–∞–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–ª–æ–≤–∞
        query_words = query.lower().split()
        
        # –ò—â–µ–º –≤—Å–µ –∑–∞–ø–∏—Å–∏
        cursor.execute('SELECT text, category FROM mifi_knowledge')
        all_facts = cursor.fetchall()
        conn.close()
        
        # –ü—Ä–æ—Å—Ç–æ–π –∞–ª–≥–æ—Ä–∏—Ç–º –ø–æ–∏—Å–∫–∞: —Å—á–∏—Ç–∞–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è —Å–ª–æ–≤
        results = []
        for text, category in all_facts:
            text_lower = text.lower()
            score = 0
            
            # –°—á–∏—Ç–∞–µ–º —Å–∫–æ–ª—å–∫–æ —Å–ª–æ–≤ –∑–∞–ø—Ä–æ—Å–∞ –µ—Å—Ç—å –≤ —Ç–µ–∫—Å—Ç–µ
            for word in query_words:
                if len(word) > 2 and word in text_lower:  # –ò—â–µ–º —Å–ª–æ–≤–∞ –¥–ª–∏–Ω–Ω–µ–µ 2 —Å–∏–º–≤–æ–ª–æ–≤
                    score += 1
            
            if score > 0:
                results.append({
                    'text': text,
                    'category': category,
                    'score': score,
                    'relevance': score / len(query_words) if query_words else 0
                })
        
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
        results.sort(key=lambda x: x['score'], reverse=True)
        
        return results[:limit]
    
    def search_by_category(self, category: str) -> List[str]:
        """–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Ñ–∞–∫—Ç—ã –∏–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        cursor.execute(
            'SELECT text FROM mifi_knowledge WHERE category = ?',
            (category,)
        )
        
        results = [row[0] for row in cursor.fetchall()]
        conn.close()
        
        return results
    
    def get_stats(self) -> Dict[str, Any]:
        """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–∞–∑—ã"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        cursor.execute('SELECT COUNT(*) FROM mifi_knowledge')
        total = cursor.fetchone()[0]
        
        cursor.execute('SELECT COUNT(DISTINCT category) FROM mifi_knowledge')
        categories = cursor.fetchone()[0]
        
        cursor.execute('SELECT category, COUNT(*) FROM mifi_knowledge GROUP BY category')
        by_category = {row[0]: row[1] for row in cursor.fetchall()}
        
        conn.close()
        
        return {
            'total_facts': total,
            'categories_count': categories,
            'by_category': by_category,
            'database': self.db_path
        }

# ==============================================
# –ü–†–û–°–¢–û–ï –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï:
# ==============================================

if __name__ == "__main__":
    # 1. –°–æ–∑–¥–∞–µ–º –±–∞–∑—É (–≤—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —É–∂–µ –≤–Ω—É—Ç—Ä–∏)
    db = SimpleVectorDB()
    
    # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    stats = db.get_stats()
    print(f"üìä –í –±–∞–∑–µ: {stats['total_facts']} —Ñ–∞–∫—Ç–æ–≤")
    for category, count in stats['by_category'].items():
        print(f"  {category}: {count}")
    
    # 3. –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–∏—Å–∫
    test_queries = [
        "–∞–¥—Ä–µ—Å –æ–±—â–µ–∂–∏—Ç–∏—è",
        "—Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç",
        "–º–æ–∂–Ω–æ –ª–∏ –∫—É—Ä–∏—Ç—å",
        "–¥–æ–∫—É–º–µ–Ω—Ç—ã –¥–ª—è –∑–∞—Å–µ–ª–µ–Ω–∏—è"
    ]
    
    for query in test_queries:
        print(f"\nüîç –ü–æ–∏—Å–∫: '{query}'")
        results = db.search(query, limit=2)
        for result in results:
            print(f"  - {result['text']} ({result['category']})")
