
"""
–ü–∞–∫–µ—Ç rag - RAG (Retrieval Augmented Generation) —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è –±–æ—Ç–∞ –ú–ò–§–ò
–ü–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
"""

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–ª–∞—Å—Å—ã
from .vector_store import VectorStore
from .retriever import Retriever

# –ü–æ–ø—Ä–æ–±—É–µ–º –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Å—Ç—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö (–µ—Å–ª–∏ –µ—Å—Ç—å)
try:
    from .simple_vector_db import SimpleVectorDB
except ImportError:
    SimpleVectorDB = None
    pass

# –í–µ—Ä—Å–∏—è –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç–∞
__version__ = "1.0.0"
__author__ = "–ö–æ–º–∞–Ω–¥–∞ –ú–ò–§–ò"
__description__ = "RAG —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –æ–±—â–µ–∂–∏—Ç–∏–π –ú–ò–§–ò"

# –°–ø–∏—Å–æ–∫ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º—ã—Ö –∏–º–µ–Ω
__all__ = [
    "VectorStore",
    "Retriever",
    "SimpleVectorDB"
]

# –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å RAG
def create_rag_context(query: str, documents: list, max_length: int = 1500) -> str:
    """
    –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞ –∏–∑ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    
    Args:
        query: –ò—Å—Ö–æ–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        documents: –°–ø–∏—Å–æ–∫ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
        max_length: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        
    Returns:
        str: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
    """
    if not documents:
        return "–í –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ –¥–∞–Ω–Ω–æ–º—É –≤–æ–ø—Ä–æ—Å—É."
    
    context_parts = ["üìö –†–µ–ª–µ–≤–∞–Ω—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π –ú–ò–§–ò:"]
    total_length = 0
    
    for i, doc in enumerate(documents, 1):
        # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç –∏–º–µ–µ—Ç –ø–æ–ª—è 'text' –∏ 'similarity'
        text = doc.get('text', doc.get('content', str(doc)))
        similarity = doc.get('similarity', doc.get('score', 0.8))
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–æ–∫—É–º–µ–Ω—Ç
        doc_text = f"\n--- –î–æ–∫—É–º–µ–Ω—Ç {i} (—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å: {similarity:.2f}) ---\n{text}"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—Ä–µ–≤—ã—Å–∏–º –ª–∏ –ª–∏–º–∏—Ç
        if total_length + len(doc_text) > max_length:
            # –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —á–∞—Å—Ç—å –∏ –ø—Ä–µ—Ä—ã–≤–∞–µ–º—Å—è
            remaining = max_length - total_length - 50  # -50 –¥–ª—è "..."
            if remaining > 100:  # –ï—Å–ª–∏ –µ—Å—Ç—å –º–µ—Å—Ç–æ –¥–ª—è —á–∞—Å—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞
                doc_text = doc_text[:remaining] + "\n... [–¥–æ–∫—É–º–µ–Ω—Ç –æ–±—Ä–µ–∑–∞–Ω]"
                context_parts.append(doc_text)
            break
        
        context_parts.append(doc_text)
        total_length += len(doc_text)
    
    return "\n".join(context_parts)

def filter_documents_by_relevance(documents: list, threshold: float = 0.5) -> list:
    """
    –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø–æ –ø–æ—Ä–æ–≥—É —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
    
    Args:
        documents: –°–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
        threshold: –ü–æ—Ä–æ–≥ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ (0.0-1.0)
        
    Returns:
        list: –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
    """
    filtered = []
    
    for doc in documents:
        similarity = doc.get('similarity', doc.get('score', 0))
        if similarity >= threshold:
            filtered.append(doc)
    
    return filtered

def get_rag_stats() -> dict:
    """
    –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ RAG —Å–∏—Å—Ç–µ–º—ã
    
    Returns:
        dict: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    """
    stats = {
        'version': __version__,
        'description': __description__,
        'available_components': __all__,
        'utilities': ['create_rag_context', 'filter_documents_by_relevance'],
        'last_update': '2024-12-15'
    }
    
    return stats

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –ø–∞–∫–µ—Ç–∞
def init_rag():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è RAG —Å–∏—Å—Ç–µ–º—ã"""
    try:
        print(f"‚úÖ RAG —Å–∏—Å—Ç–µ–º–∞ v{__version__} –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")
        print(f"   –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã: {', '.join(__all__)}")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –æ—Å–Ω–æ–≤–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        if SimpleVectorDB:
            print(f"   –î–æ—Å—Ç—É–ø–Ω–∞ –ø—Ä–æ—Å—Ç–∞—è –≤–µ–∫—Ç–æ—Ä–Ω–∞—è –±–∞–∑–∞: SimpleVectorDB")
        
        return True
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ RAG: {e}")
        return False

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –ø–∞–∫–µ—Ç–∞
if __name__ != "__main__":
    init_rag()

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞–∫–µ—Ç–∞
if __name__ == "__main__":
    print(f"–ü–∞–∫–µ—Ç RAG v{__version__}")
    print(__description__)
    print(f"\n–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:")
    
    for item in __all__:
        print(f"  ‚Ä¢ {item}")
    
    # –¢–µ—Å—Ç —É—Ç–∏–ª–∏—Ç
    print("\nüß™ –¢–µ—Å—Ç —É—Ç–∏–ª–∏—Ç:")
    
    # –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    test_documents = [
        {'text': '–û–±—â–µ–∂–∏—Ç–∏–µ ‚Ññ1: –ú–æ—Å–∫–≤–∞, —É–ª. –ú–æ—Å–∫–≤–æ—Ä–µ—á—å–µ, 2–∫1', 'similarity': 0.9},
        {'text': '–°—Ç–æ–∏–º–æ—Å—Ç—å: 1200-2500 —Ä—É–±–ª–µ–π –≤ –º–µ—Å—è—Ü', 'similarity': 0.7},
        {'text': '–ì–æ—Å—Ç–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã –¥–æ 23:00', 'similarity': 0.5},
    ]
    
    context = create_rag_context("–∞–¥—Ä–µ—Å –æ–±—â–µ–∂–∏—Ç–∏—è", test_documents)
    print("–°–æ–∑–¥–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç:")
    print(context[:200] + "..." if len(context) > 200 else context)
    
    # –¢–µ—Å—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    filtered = filter_documents_by_relevance(test_documents, threshold=0.6)
    print(f"\n–î–æ–∫—É–º–µ–Ω—Ç—ã —Å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å—é >= 0.6: {len(filtered)} –∏–∑ {len(test_documents)}")
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    print("\nüìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ RAG:")
    stats = get_rag_stats()
    for key, value in stats.items():
        if key != 'utilities':
            print(f"  {key}: {value}")
    
    print("\n‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã!")
